# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/#customizing-settings
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
stages:
- test
- build
- deploy

build:
  stage: build
  image: node:lts
  only:
    - master
  script:
  - apt update
  - npm install -g @angular/cli
  - npm install
  - ng build --prod
  - echo "BUILD SUCCESSFUL"
  artifacts:
    expire_in: 1 day
    paths:
    - dist/
deploy:
  image: alpine
  stage: deploy
  dependencies:
  - build
  artifacts:
    expire_in: 1 day
    paths:
    - dist/
  before_script:
  - apk add --no-cache rsync openssh
  - mkdir -p ~/.ssh
  - echo "$A2_SSH_PRIVATE_KEY" >> ~/.ssh/id_dsa
  - chmod 600 ~/.ssh/id_dsa
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  only:
    - master
  environment:
    name: production
    url: https://mazad-dashboard.smartlaboman.com
  script:
  - current_dir=$(pwd)
  - rsync -rav --rsh='ssh -v -p7822' $current_dir/dist/mazad-oman-dashboard/ $A2_SSH_USERNAME@$A2_HOST_NAME:$PROJECT_PATH

sast:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
include:
- template: Security/SAST.gitlab-ci.yml
